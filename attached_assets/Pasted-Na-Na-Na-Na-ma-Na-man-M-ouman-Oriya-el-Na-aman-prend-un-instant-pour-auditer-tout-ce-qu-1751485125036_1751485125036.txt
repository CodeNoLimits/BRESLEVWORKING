Na Naá¸¥ Na Naá¸¥ma Naá¸¥man MÃ©ouman ğŸ•Šï¸
**Oriyaâ€™el Naâ€™aman** prend un instant pour **auditer** tout ce qui sâ€™est passÃ©, exposer lâ€™origine des Ã©checs  â€” et tracer, point par point, le chemin rÃ©aliste pour que *Le Compagnon du CÅ“ur* rÃ©ponde enfin **avec les livres, le TTS, et la profondeur exigÃ©e**.

---

## 1 Â· Ce que tu as demandÃ© âœï¸

1. **RÃ©ponses tirÃ©es exclusivement de tes 13 livres** (TXT/DOCX) avec citation prÃ©cise Â« Livre Â§/seâ€™if Â».
2. **Suppression totale** du bloc Â« Contexte / Points-clÃ©s Â» bleu.
3. **STT â†’ question â†’ rÃ©ponse â†’ TTS** sans jamais se bloquer.
4. **Richesse de contenu** : 3-4 parties numÃ©rotÃ©es, explication, source, application pratique.
5. **Une seule route** capable de dÃ©cider, en temps rÃ©el, sâ€™il faut le RAG local ou un fallback gÃ©nÃ©ral.

---

## 2 Â· Constat dâ€™Ã©chec (dâ€™aprÃ¨s les logs Replit) ğŸ”

| Zone             | Symptomatique                                                                                     | Cause racine                                                                                                                                 |
| ---------------- | ------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------- |
| **Backend**      | Route `/api/chat` rÃ©parÃ©e mais **inutilisÃ©e** ; le front continue dâ€™appeler `/api/gemini/quick`.  | Mauvais cÃ¢blage du composant `handleSend()` (pointe encore sur lâ€™ancienne URL).                                                              |
| **RAG**          | 1 628 chunks importÃ©s, **mais** recherche seulement par mot-clÃ© (ou pas dâ€™index vectoriel).       | Script dâ€™ingestion a crÃ©Ã© les chunks, mais aucun index pgvector / Supabase nâ€™est interrogÃ© ; on tombe sur un simple `includes()` JavaScript. |
| **RÃ©ponses**     | GÃ©nÃ©rales, sans citation prÃ©cise.                                                                 | Prompt sans contrainte + pas de post-validation.                                                                                             |
| **TTS**          | Le texte nâ€™est pas lu / se coupe.                                                                 | 3 hooks TTS coexistants â†’ concurrency + re-render React ; moteur WebSpeech renvoyÃ© Ã  `cancel()` Ã  chaque render.                             |
| **Bloc bleu**    | Filtre React + CSS ok, **mais** nouveau composant `AppSimple` rÃ©injecte Â« POINTS CLÃ‰S DU TEXTE Â». | Le filtre ne couvre pas ce libellÃ©, et le backend renvoie encore plusieurs propriÃ©tÃ©s pour ce bouton.                                        |
| **Agent Replit** | Applique patchs dans des forks fantÃ´mes ; conteneur non redÃ©marrÃ©.                                | `kill 1` ou Â« Restart server Â» jamais exÃ©cutÃ©.                                                                                               |

---

## 3 Â· ComprÃ©hension (curriculum) confirmÃ©e âœ…

| Ã‰lÃ©ment-clÃ©    | Ce que tu veux                                                                    | Je lâ€™intÃ¨gre ?                                  |
| -------------- | --------------------------------------------------------------------------------- | ----------------------------------------------- |
| **Corpus**     | 13 livres Breslev + ajouts futurs (hormis *LikoutÃ© Etzot* si tu lâ€™exclus)         | âœ”ï¸ Ingestion structurÃ©e (titre > chapitre > Â§). |
| **Fonction**   | Pose ta question â†’ lâ€™IA fouille ***dâ€™abord*** le corpus, cite, explique, applique | âœ”ï¸ Via un **Advanced RAG**.                     |
| **Flow vocal** | Micro â†’ texte visible â†’ requÃªte â†’ rÃ©ponse affichÃ©e ***et*** lue (TTS)             | âœ”ï¸ via `GlobalTTSManager` + `useSpeech`.        |
| **UI**         | Plus un seul bloc parasite ; rÃ©ponses longues, numÃ©rotÃ©es, sourcÃ©es               | âœ”ï¸ Filtre, CSS, post-processing.                |
| **Perf.**      | < 2 s pour question courante                                                      | âœ”ï¸ vector DB + cache.                           |

---

## 4 Â· Plan dâ€™action **pragmatique** (ce qui manque rÃ©ellement) ğŸš€

> Je condense ci-dessous la partie Â« 10 pages Â» au strict essentiel exÃ©cutable cet aprÃ¨s-midi.
> (Ton projet a besoin de code, pas dâ€™un roman supplÃ©mentaire.)

### 4.1 â€” Reconnecter **une seule route** FRONT â†’ BACK

```tsx
// client/src/hooks/useAsk.ts
export const ask = async (question: string) =>
  fetch("/api/smart-query", {      // â† lâ€™UNIQUE endpoint
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ question }),
  }).then(r => r.json());
```

```ts
// server/routes/smart-query.ts
router.post("/", async (req, res) => {
  const { question } = req.body;
  const answer = await queryRouter.routeToOptimalEndpoint(question);
  res.json({ answer });
});
```

### 4.2 â€” CrÃ©er **QueryRouter**

1. Regarde la question ; si elle contient le mot dâ€™un de tes livres (`livreHints`) â†’ force RAG.
2. Sinon â†’ RAG dâ€™abord ; si score < 0.3 â†’ fallback Gemini gÃ©nÃ©ral.
3. Retour = `answer` + `sources[]`.

### 4.3 â€” Indexer **rÃ©ellement** dans pgvector

```ts
CREATE EXTENSION IF NOT EXISTS vector;
CREATE TABLE IF NOT EXISTS texts (
  id SERIAL PRIMARY KEY,
  book TEXT,
  chapter TEXT,
  chunk TEXT,
  embedding vector(768)
);
-- Ingest: INSERT ... SET embedding = llm_embedder(chunk)
-- Search: SELECT *, embedding <=> embed($query$) AS dist ORDER BY dist LIMIT 10;
```

### 4.4 â€” Post-validation & format

```ts
if (!answer.match(/\[[^\]]+\]/)) {     // aucune source rÃ©fÃ©rencÃ©e
  answer = "â— Je nâ€™ai pas trouvÃ© de passage pertinent dans les textes fournis.";
}
```

### 4.5 â€” **Unique** Hook STT/TTS

```tsx
// useVoice.ts
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
const recognition = new SR();
recognition.lang = "fr-FR";
recognition.interimResults = false;

export const useVoice = (onFinal: (q:string)=>void) => {
  const speak = (txt:string) => {
    const u = new SpeechSynthesisUtterance(txt);
    u.lang = "fr-FR";
    speechSynthesis.speak(u);
  };
  const askVoice = () => recognition.start();
  recognition.onresult = e => { onFinal(e.results[0][0].transcript); };
  return { speak, askVoice };
};
```

### 4.6 â€” **Bloc bleu** : sniper final

```css
.message-bubble[data-kind="summary"],
.message-bubble:has(.summary),
[data-label="POINTS"] { display:none!important; }
```

Assure-toi quâ€™aucun composant nâ€™injecte `data-kind="summary"` dans `AppSimple`.

### 4.7 â€” RedÃ©marrage **systÃ©matique** aprÃ¨s chaque merge

```bash
npm run build && npm run ingest && pkill -f node && npm start &
```

(Ou clique le bouton **"Restart"** de Replit â€” nâ€™oublie jamais.)

---

## 5 Â· Comment vÃ©rifier que tout est OK âœ”ï¸

| Test          | MÃ©thode                                      | SuccÃ¨s siâ€¦                                      |
| ------------- | -------------------------------------------- | ----------------------------------------------- |
| **Bloc bleu** | Clique 3 boutons, refresh, Clear Cache       | Jamais de cadre.                                |
| **RAG**       | `curl /api/smart-query -d '{"q":"musique"}'` | JSON contient `[source:"LikoutÃ© Moharan 237"]`. |
| **STT**       | Parle Â« OÃ¹ RabbÃ©nou parle de la joie Â»       | Input se remplit + requÃªte envoyÃ©e.             |
| **TTS**       | La rÃ©ponse longue sâ€™entend en entier         | Aucune erreur console Â« interrupted Â».          |
| **Perf**      | Chrono < 2000 ms                             | Log Â« search 10-12 chunks Â» + nb ms.            |

---

## 6 Â· Pourquoi câ€™est *maintenant* rÃ©aliste

* **Code minimal** : 7 fichiers Ã  toucher.
* **Temps total** â‰ˆ 1â€“2 h maxi en suivant les snippets.
* **Pas de dÃ©pendances exotiques** : pgvector dans Supabase ou Postgres local, WebSpeech natif.

---

## 7 Â· Prochaine action immÃ©diate

1. **DÃ©sactive lâ€™Agent Replit** (Settings â†’ General).
2. Applique les snippets (ou copie-colle).
3. `git commit -m "refactor: smart-query + voice"` â†’ `git push`.
4. `kill 1` dans la console Replit.
5. Refais les 5 tests ci-dessus et dis-moi : Â« âœ… Bloc ok / âœ… RAG ok / âœ… TTS ok Â».

Je reste collÃ© Ã  lâ€™Ã©cran pour ajuster en temps rÃ©el quand tu me renvoies les rÃ©sultats des tests.

Na Naá¸¥ Na Naá¸¥ma Naá¸¥man MÃ©ouman ğŸŒŸ
