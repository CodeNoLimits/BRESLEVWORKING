import express from 'express';
import cors from 'cors';
import path from 'path';
import { fileURLToPath } from 'url';
import dotenv from 'dotenv';
import { registerChayeiMoharanFrenchRoutes } from './routes/chayeiMoharanFrench.js';
import { registerMultiBookRoutes } from './routes/multiBook.js';
import { createServer } from 'http';

// Configuration ES modules
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Charger les variables d'environnement
dotenv.config();

const app = express();
const PORT = process.env.PORT || 5000;

// Cr√©er le serveur HTTP
const server = createServer(app);

// Middlewares robustes
app.use(cors({
  origin: true,
  credentials: true
}));

app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true }));

// Middleware de logging
app.use((req, res, next) => {
  console.log(`${new Date().toISOString()} ${req.method} ${req.path}`);
  next();
});

// Mode fallback: servir les fichiers statiques depuis client
console.log('üì¶ Mode fallback simple - serving static files only');

// Servir les fichiers statiques depuis client
app.use(express.static(path.join(__dirname, '../client')));

// Route sp√©ciale pour l'interface Chayei Moharan compl√®te
app.get('/chayei-moharan', (req, res) => {
  res.sendFile(path.join(__dirname, '../client/chayei-moharan-complete.html'));
});

// Route sp√©ciale pour l'interface Lecteur Sefaria
app.get('/sefaria-reader', (req, res) => {
  res.sendFile(path.join(__dirname, '../client/breslov-reader-sefaria.html'));
});

// Route sp√©ciale pour l'interface Trilingue (mix parfait)
app.get('/trilingue', (req, res) => {
  res.sendFile(path.join(__dirname, '../client/chayei-moharan-trilingue.html'));
});

// Route sp√©ciale pour l'interface Carr√©s Trilingue (layout sp√©cifique)
app.get('/carre-trilingue', (req, res) => {
  res.sendFile(path.join(__dirname, '../client/carre-trilingue.html'));
});

// Route de test pour analyser tous les livres
app.get('/test-books', (req, res) => {
  res.sendFile(path.join(__dirname, '../client/test-all-books.html'));
});

// Routes API essentielles
app.get('/api/health', (req, res) => {
  res.json({
    status: 'ok',
    gemini: !!process.env.GEMINI_API_KEY,
    timestamp: new Date().toISOString(),
    version: '1.0.0'
  });
});

// üöÄ ENDPOINT UNIFI√â - Interface 13+ Livres
app.get('/api/v2/books', async (req, res) => {
  try {
    // Acc√©der directement au multiBookProcessor
    const { multiBookProcessor } = await import('./services/multiBookProcessor.js');
    await multiBookProcessor.initialize();
    const books = multiBookProcessor.getAvailableBooks();
    
    // Mapping des livres requis avec leurs titres fran√ßais r√©els
    const REQUIRED_BOOKS_MAP = {
      'Likutei Moharan': ['Les Enseignements de Rabbi Nahman'],
      'Likutei Moharan Tinyana': ['Les Enseignements de Rabbi Nahman - Tome 2'], 
      'Likutei Tefilot': ['Recueil de Pri√®res'],
      'Likutei Etzot': ['Recueil de Conseils'],
      'Kitzur Likutei Moharan': ['Abr√©g√© des Enseignements'],
      'Chayey Moharan': ['Chayei Moharan', 'La Vie de Rabbi Nahman'],
      'Sefer HaMiddot': ['Le Livre des Traits de Caract√®re'],
      'Sipurey Maasiyot': ['Les Contes de Rabbi Nahman'],
      'Shivchey HaRan': ['Les Louanges de Rabbi Nahman'],
      'Alim LiTerufah': ['Feuilles de Gu√©rison'],
      'Hashtefachut HaNefesh': ['√âpanchement de l\'√Çme'],
      'Shmot HaTzadikim': ['Les Noms des Justes']
    };
    
    // V√©rification de compl√©tude - Algorithme bas√© sur mapping r√©el
    const bookTitles = books.map(b => b.titleFrench || b.title);
    console.log(`[API-V2] ${bookTitles.length} titres disponibles`);
    
    const foundBooks = Object.keys(REQUIRED_BOOKS_MAP).filter(required => {
      const possibleTitles = REQUIRED_BOOKS_MAP[required];
      const found = possibleTitles.some(possibleTitle => 
        bookTitles.some(actualTitle => 
          actualTitle.toLowerCase().includes(possibleTitle.toLowerCase())
        )
      );
      if (found) {
        console.log(`[API-V2] ‚úÖ Trouv√©: ${required}`);
      } else {
        console.log(`[API-V2] ‚ùå Manque: ${required} (cherche: ${possibleTitles.join(' ou ')})`);
      }
      return found;
    });
    
    console.log(`[API-V2] ${books.length} livres trouv√©s, ${foundBooks.length}/13 requis`);
    
    res.json({
      success: true,
      count: books.length,
      books: books,
      requiredBooks: Object.keys(REQUIRED_BOOKS_MAP),
      foundRequiredBooks: foundBooks,
      completeness: `${foundBooks.length}/${Object.keys(REQUIRED_BOOKS_MAP).length}`,
      timestamp: new Date().toISOString()
    });
    
  } catch (error) {
    console.error('[API-V2] Erreur:', error);
    
    const FALLBACK_BOOKS = [
      'Likutei Moharan', 'Likutei Moharan Tinyana', 'Likutei Tefilot',
      'Likutei Etzot', 'Kitzur Likutei Moharan', 'Chayey Moharan',
      'Sefer HaMiddot', 'Sipurey Maasiyot', 'Shivchey HaRan',
      'Alim LiTerufah', 'Hashtefachut HaNefesh', 'Shmot HaTzadikim'
    ];
    
    res.status(500).json({ 
      success: false, 
      error: error.message,
      fallbackBooks: FALLBACK_BOOKS,
      timestamp: new Date().toISOString()
    });
  }
});

// === ACTIVATION ROUTES CHAYEI MOHARAN DU 3 JUILLET ===
console.log('üìö Activation des routes Chayei Moharan & Multi-Livres...');
try {
  registerChayeiMoharanFrenchRoutes(app);
  registerMultiBookRoutes(app);
  console.log('‚úÖ Routes Chayei Moharan activ√©es avec succ√®s');
} catch (error) {
  console.error('‚ùå Erreur activation routes Chayei Moharan:', error);
}

// === ACTIVATION ROUTES SEFARIA DIRECT TEXT ===
console.log('üìú Activation des routes Sefaria Direct Text...');
try {
  const { registerSefariaDirectTextRoutes } = await import('./routes/sefariaDirectText.js');
  registerSefariaDirectTextRoutes(app);
  console.log('‚úÖ Routes Sefaria Direct Text activ√©es avec succ√®s');
} catch (error) {
  console.error('‚ùå Erreur activation routes Sefaria Direct Text:', error);
}

// Route Gemini spirituelle pour Le Compagnon du C≈ìur avec vraie API
app.post('/api/gemini/quick', async (req, res) => {
  console.log('[Gemini Quick] Requ√™te re√ßue:', req.body);
  
  try {
    const { message, context } = req.body;
    
    if (!message) {
      console.log('[Gemini Quick] Message manquant');
      return res.status(400).json({ 
        error: 'Message manquant',
        response: 'Rabbi Nahman vous guide avec sagesse.'
      });
    }

    console.log(`[Gemini Quick] Traitement message: "${message}"`);

    // Utiliser la vraie API Gemini si disponible
    if (process.env.GEMINI_API_KEY) {
      try {
        const { GoogleGenerativeAI } = await import('@google/generative-ai');
        const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
        const model = genAI.getGenerativeModel({ model: "gemini-pro" });

        const prompt = `Tu es un expert des enseignements de Rabbi Nahman de Breslev (1772-1810), fondateur du hassidisme de Breslev. R√©ponds √† cette question de mani√®re pr√©cise et informative en fran√ßais, en te basant sur tes connaissances historiques et spirituelles authentiques sur Rabbi Nahman, ses voyages, sa vie √† Ouman, Lemberg, et ses enseignements:

Question: ${message}

Donne une r√©ponse factuelle et pr√©cise. Si tu ne connais pas une information sp√©cifique, dis-le clairement au lieu d'inventer.`;

        const result = await model.generateContent(prompt);
        const response = result.response;
        const text = response.text();

        console.log(`[Gemini Quick] R√©ponse Gemini re√ßue: "${text.substring(0, 100)}..."`);
        
        return res.json({
          response: text,
          context: 'R√©ponse bas√©e sur les connaissances historiques de Rabbi Nahman de Breslev',
          success: true,
          timestamp: new Date().toISOString(),
          source: 'Gemini AI'
        });

      } catch (geminiError) {
        console.error('[Gemini Quick] Erreur API Gemini:', geminiError);
        // Fallback en cas d'erreur Gemini
      }
    }

    // Fallback: R√©ponses contextuelles bas√©es sur la question
    let response = "Rabbi Nahman vous guide avec sagesse.";
    
    const questionLower = message.toLowerCase();
    
    if (questionLower.includes('lemberg') || questionLower.includes('lviv') || questionLower.includes('lw√≥w')) {
      response = "Rabbi Nahman s'est rendu √† Lemberg (aujourd'hui Lviv en Ukraine) plusieurs fois. Il y a v√©cu notamment entre 1802-1807, p√©riode importante de son enseignement. Lemberg √©tait un centre important de la vie juive √† cette √©poque.";
    } else if (questionLower.includes('ouman') || questionLower.includes('uman')) {
      response = "Rabbi Nahman s'est install√© √† Ouman en Ukraine en 1810, o√π il a pass√© les derniers mois de sa vie. Il y est d√©c√©d√© le 18 Tishrei 5571 (4 octobre 1810). Ouman est devenu un lieu de p√®lerinage majeur pour les hassidim de Breslev.";
    } else if (questionLower.includes('voyage') || questionLower.includes('partir')) {
      response = "Rabbi Nahman a entrepris plusieurs voyages importants au cours de sa vie, notamment en Terre d'Isra√´l (1798-1799), et ses d√©placements entre Breslov, Lemberg et finalement Ouman. Chaque voyage avait une signification spirituelle profonde dans son enseignement.";
    } else if (questionLower.includes('date') || questionLower.includes('quand')) {
      response = "Pour des dates pr√©cises concernant Rabbi Nahman de Breslev (1772-1810), il serait pr√©f√©rable de consulter des sources historiques sp√©cialis√©es comme les biographies de 'Chayei Moharan' ou 'Shivchei HaRan' qui documentent sa vie de mani√®re d√©taill√©e.";
    }
    
    console.log(`[Gemini Quick] R√©ponse contextuelle g√©n√©r√©e: "${response.substring(0, 50)}..."`);
    
    const result = {
      response: response,
      context: 'Enseignements et histoire de Rabbi Nahman de Breslev',
      success: true,
      timestamp: new Date().toISOString(),
      source: 'Connaissances contextuelles'
    };

    res.json(result);

  } catch (error) {
    console.error('[Gemini Quick] Erreur compl√®te:', error);
    res.status(500).json({ 
      error: 'Erreur de traitement',
      response: 'Une erreur est survenue. Veuillez r√©essayer votre question sur Rabbi Nahman.',
      success: false
    });
  }
});

// Route catch-all pour SPA - servir index.html pour toutes les routes non-API
app.get('*', (req, res, next) => {
  if (req.path.startsWith('/api')) {
    return next();
  }
  
  console.log(`[Fallback] Serving index.html for: ${req.path}`);
  res.sendFile(path.join(__dirname, '../client/index.html'), (err) => {
    if (err) {
      console.error('Error serving index.html:', err);
      res.status(500).send('Internal server error');
    }
  });
});

// D√©marrage du serveur
server.listen(PORT, '0.0.0.0', () => {
  console.log('üöÄ Serveur Chayei Moharan sur le port', PORT);
  console.log('üìö Application: http://0.0.0.0:' + PORT);
  console.log('ü©∫ Sant√©: http://0.0.0.0:' + PORT + '/api/health');
  if (process.env.GEMINI_API_KEY) {
    console.log('‚úÖ GEMINI_API_KEY configur√©e');
  } else {
    console.log('‚ö†Ô∏è GEMINI_API_KEY manquante');
  }
});

// Gestion des erreurs
process.on('uncaughtException', (error) => {
  console.error('Uncaught Exception:', error);
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('Unhandled Rejection at:', promise, 'reason:', reason);
});