<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üïäÔ∏è Le Compagnon du C≈ìur - Layout Carr√©s Trilingue</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        spiritual: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a'
                        },
                        sacred: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#f59e0b',
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .rtl-text {
            direction: rtl;
            text-align: right;
            font-family: 'Times New Roman', serif;
            line-height: 1.8;
        }
        .hebrew-text {
            font-family: 'David Libre', 'Times New Roman', serif;
            font-size: 1.1em;
            line-height: 2;
        }
        .text-container {
            background: rgba(15, 23, 42, 0.7);
            border: 2px solid rgba(251, 191, 36, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            height: 400px;
            overflow-y: auto;
        }
        .french-container {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(59, 130, 246, 0.1));
            border: 2px solid rgba(34, 197, 94, 0.3);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .spiritual-glow {
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-spiritual-900 via-spiritual-800 to-spiritual-900 text-white min-h-screen">
    <div id="carre-trilingue-app"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // === COMPOSANT PRINCIPAL CARR√âS TRILINGUE ===
        function CarreTrilingueApp() {
            const [selectedBook, setSelectedBook] = useState('Chayei Moharan');
            const [selectedSection, setSelectedSection] = useState('3');
            const [isLoading, setIsLoading] = useState(false);
            const [userQuestion, setUserQuestion] = useState('');
            const [messages, setMessages] = useState([]);
            const [isSearching, setIsSearching] = useState(false);
            
            // Textes
            const [hebrewText, setHebrewText] = useState([]);
            const [englishText, setEnglishText] = useState([]);
            const [frenchText, setFrenchText] = useState('');
            const [showFrench, setShowFrench] = useState(false);
            const [showEnglish, setShowEnglish] = useState(true);
            const [isTranslating, setIsTranslating] = useState(false);
            const [frenchProgress, setFrenchProgress] = useState(0);
            
            // TTS/STT States
            const [isTTSEnabled, setIsTTSEnabled] = useState(true);
            const [isListening, setIsListening] = useState(false);
            const [isSpeaking, setIsSpeaking] = useState(false);
            const [voices, setVoices] = useState([]);
            const [selectedVoice, setSelectedVoice] = useState(null);
            
            const recognitionRef = useRef(null);
            // COLLECTION BRESLOV COMPL√àTE - CHAYEI MOHARAN EN PRIORIT√â
            const availableBooks = [
                'Chayei Moharan', // FOCUS PRINCIPAL - sections 3,4,5 avec extracteur intelligent
                'Likutei Moharan', 
                'Sichot HaRan',
                'Shivchei HaRan',
                'Sippurei Maasiyot',
                'Likutei Tefilot',
                'Sefer HaMiddot',
                'Likutei Halakhot',
                'Likutei Etzot',
                'Alim LiTerufah',
                'Kitzur Likutei Moharan'
            ];

            // LIMITES DE CHAPITRES PAR LIVRE (bas√© sur Sefaria - CORRIG√âES)
            const bookChapterLimits = {
                'Chayei Moharan': 50,
                'Likutei Moharan': 286,  // MAX 286 (PAS 290+)
                'Sichot HaRan': 307,
                'Shivchei HaRan': 50,
                'Sippurei Maasiyot': 13,  // MAX 13 (PAS plus)
                'Likutei Tefilot': 210,
                'Sefer HaMiddot': 500,
                'Likutei Halakhot': 200,
                'Likutei Etzot': 100,
                'Alim LiTerufah': 40,
                'Kitzur Likutei Moharan': 45
            };

            // MODES DE RECHERCHE CONTEXTUELLE
            const [searchMode, setSearchMode] = useState('Contexte de cet enseignement');
            const searchModes = [
                'Contexte de cet enseignement',
                'Contexte de ce livre',
                'Contexte de tous les livres'
            ];

            // Fonction pour obtenir la limite de chapitres
            const getMaxChapters = (bookName) => {
                return bookChapterLimits[bookName] || 50;
            };
            
            // Fonction de recherche contextuelle
            const performContextualSearch = async (question, mode) => {
                setIsSearching(true);
                
                try {
                    let endpoint = '';
                    let payload = { query: question };
                    
                    switch (mode) {
                        case 'Contexte de cet enseignement':
                            endpoint = '/api/smart-search/search/' + encodeURIComponent(selectedBook);
                            payload.sectionNumber = selectedSection;
                            break;
                        case 'Contexte de ce livre':
                            endpoint = '/api/smart-search/search/' + encodeURIComponent(selectedBook);
                            payload.searchEntireBook = true;
                            break;
                        case 'Contexte de tous les livres':
                            endpoint = '/api/smart-search/search';
                            payload.targetBooks = availableBooks;
                            break;
                        default:
                            endpoint = '/api/gemini/quick';
                            payload = { message: question, context: selectedBook };
                    }
                    
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const data = await response.json();
                    
                    if (data.success || data.result) {
                        const aiMessage = {
                            type: 'ai',
                            content: data.result?.aiResponse || data.answer || data.response || 'R√©ponse re√ßue',
                            source: mode,
                            searchMode: mode,
                            foundInText: data.foundInText || true,
                            timestamp: Date.now()
                        };
                        setMessages(prev => [...prev, aiMessage]);
                        
                        // TTS automatique
                        if (isTTSEnabled) {
                            speak(aiMessage.content);
                        }
                    } else {
                        throw new Error(data.error || 'Erreur de recherche');
                    }
                } catch (error) {
                    console.error('‚ùå Erreur recherche contextuelle:', error);
                    const errorMessage = { 
                        type: 'error', 
                        content: `Erreur recherche (${mode}): ${error.message}`, 
                        timestamp: Date.now() 
                    };
                    setMessages(prev => [...prev, errorMessage]);
                } finally {
                    setIsSearching(false);
                }
            };

            // === INITIALISATION ===
            useEffect(() => {
                console.log('üïäÔ∏è Layout Carr√©s Trilingue - Initialisation...');
                initializeTTS();
                loadSefariaText();
                
                return () => {
                    if (speechSynthesis) {
                        speechSynthesis.cancel();
                    }
                };
            }, []);

            // === TTS SYSTEM (OPTIMIS√â DU 3 JUILLET) ===
            const initializeTTS = () => {
                console.log('üó£Ô∏è Initialisation TTS optimis√©e...');
                
                const loadVoices = () => {
                    const allVoices = speechSynthesis.getVoices();
                    const frenchVoices = allVoices.filter(voice => 
                        voice.lang.startsWith('fr') || voice.name.toLowerCase().includes('french')
                    );
                    
                    console.log(`üá´üá∑ Voix fran√ßaises trouv√©es:`, frenchVoices.map(v => v.name));
                    setVoices(frenchVoices);
                    
                    if (frenchVoices.length > 0 && !selectedVoice) {
                        const amelie = frenchVoices.find(v => v.name === 'Am√©lie') || frenchVoices[0];
                        setSelectedVoice(amelie);
                        console.log(`üéµ Voix s√©lectionn√©e: ${amelie.name}`);
                    }
                };

                loadVoices();
                speechSynthesis.onvoiceschanged = loadVoices;

                // Speech Recognition avec d√©lai optimis√© (2 secondes)
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.lang = 'fr-FR';
                    recognitionRef.current.continuous = false;
                    recognitionRef.current.interimResults = false;

                    recognitionRef.current.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        console.log('üé§ Transcription:', transcript);
                        setUserQuestion(transcript);
                        setIsListening(false);
                        
                        // ENVOI AUTOMATIQUE apr√®s reconnaissance vocale
                        setTimeout(() => {
                            if (transcript.trim()) {
                                console.log('üöÄ Envoi automatique de la question vocale:', transcript);
                                // Simuler le clic sur rechercher en utilisant l'√©tat temporaire
                                searchInTextWithTranscript(transcript);
                            }
                        }, 100);
                    };

                    recognitionRef.current.onerror = (event) => {
                        console.error('‚ùå Erreur reconnaissance vocale:', event.error);
                        setIsListening(false);
                    };

                    recognitionRef.current.onend = () => {
                        setIsListening(false);
                    };
                }
            };

            const speak = (text, language = 'fr') => {
                if (!isTTSEnabled) return;
                
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                const allVoices = speechSynthesis.getVoices();
                
                if (language === 'he') {
                    utterance.voice = allVoices.find(v => v.lang.includes('he')) || allVoices[0];
                    utterance.rate = 0.7;
                    utterance.pitch = 1.1;
                } else if (language === 'en') {
                    utterance.voice = allVoices.find(v => v.lang.includes('en')) || allVoices[0];
                    utterance.rate = 0.9;
                } else {
                    utterance.voice = selectedVoice || allVoices[0];
                    utterance.rate = 0.9;
                }
                
                utterance.onstart = () => {
                    setIsSpeaking(true);
                    console.log('üîä TTS d√©marr√©');
                };
                
                utterance.onend = () => {
                    setIsSpeaking(false);
                    console.log('üîä TTS termin√©');
                };
                
                utterance.onerror = (event) => {
                    console.error('‚ùå Erreur TTS:', event);
                    setIsSpeaking(false);
                };
                
                speechSynthesis.speak(utterance);
            };

            const startListening = () => {
                if (recognitionRef.current && !isListening) {
                    // Arr√™ter TTS si en cours
                    if (isSpeaking) {
                        speechSynthesis.cancel();
                        setIsSpeaking(false);
                    }
                    
                    setIsListening(true);
                    recognitionRef.current.start();
                    console.log('üé§ √âcoute d√©marr√©e (d√©lai optimis√© 2s)');
                }
            };

            const stopSpeaking = () => {
                speechSynthesis.cancel();
                setIsSpeaking(false);
            };

            // === CHARGEMENT TEXTE SEFARIA ===
            const loadSefariaText = async () => {
                setIsLoading(true);
                try {
                    console.log(`[Carr√©Trilingue] Chargement: ${selectedBook} section ${selectedSection}`);
                    
                    const response = await fetch(`/api/sefaria-direct/${encodeURIComponent(selectedBook)}/${selectedSection}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        setHebrewText(data.hebrewText || []);
                        setEnglishText(data.englishText || []);
                        setFrenchText('');
                        setShowFrench(false);
                        setFrenchProgress(0);
                        
                        console.log(`‚úÖ Texte charg√©: ${data.totalSegments} segments anglais, ${data.hebrewSegments} segments h√©breux`);
                    } else {
                        console.error('‚ùå Erreur Sefaria:', data.error);
                    }
                } catch (error) {
                    console.error('‚ùå Erreur chargement:', error);
                } finally {
                    setIsLoading(false);
                }
            };

            // === TRADUCTION FRAN√áAISE LAZY ===
            const translateToFrench = async () => {
                if (isTranslating) return;
                
                setIsTranslating(true);
                try {
                    const startIndex = frenchProgress;
                    const segmentsToTranslate = englishText.slice(startIndex, startIndex + 5);
                    const textToTranslate = segmentsToTranslate.join('\n\n');
                    
                    console.log(`üá´üá∑ Traduction segments ${startIndex}-${startIndex + 5}/${englishText.length}`);
                    
                    const response = await fetch('/api/sefaria-direct/translate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: textToTranslate,
                            language: 'en',
                            bookTitle: selectedBook
                        })
                    });
                    
                    const data = await response.json();
                    if (data.translation) {
                        if (frenchProgress === 0) {
                            setFrenchText(data.translation);
                        } else {
                            setFrenchText(prev => prev + '\n\n' + data.translation);
                        }
                        setFrenchProgress(startIndex + 5);
                        setShowFrench(true);
                    }
                } catch (error) {
                    console.error('‚ùå Erreur traduction:', error);
                    setFrenchText(prev => prev + '\n\nErreur de traduction fran√ßaise');
                } finally {
                    setIsTranslating(false);
                }
            };

            const continueTranslation = () => {
                if (frenchProgress < englishText.length) {
                    translateToFrench();
                }
            };

            // === RECHERCHE IA DANS LE TEXTE ===
            const searchInText = async () => {
                if (!userQuestion.trim() || isSearching) return;
                
                setIsSearching(true);
                const newMessage = { type: 'user', content: userQuestion, timestamp: Date.now() };
                setMessages(prev => [...prev, newMessage]);
                
                try {
                    const response = await fetch('/api/sefaria-direct/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            query: userQuestion,
                            bookTitle: selectedBook,
                            sectionNumber: selectedSection
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        const aiMessage = {
                            type: 'ai',
                            content: data.answer,
                            source: `${data.sourceBook} - ${data.sourceReference}`,
                            foundInText: data.foundInText,
                            timestamp: Date.now()
                        };
                        setMessages(prev => [...prev, aiMessage]);
                        
                        // TTS automatique pour la r√©ponse
                        if (isTTSEnabled) {
                            speak(data.answer);
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Erreur recherche:', error);
                    const errorMessage = { 
                        type: 'error', 
                        content: 'Erreur lors de la recherche IA', 
                        timestamp: Date.now() 
                    };
                    setMessages(prev => [...prev, errorMessage]);
                } finally {
                    setIsSearching(false);
                    setUserQuestion('');
                }
            };

            // === RECHERCHE AUTOMATIQUE APR√àS RECONNAISSANCE VOCALE ===
            const searchInTextWithTranscript = async (transcript) => {
                if (!transcript.trim() || isSearching) return;
                
                // Utiliser la recherche contextuelle avec le mode s√©lectionn√©
                await performContextualSearch(transcript, searchMode);
            };

            // === RECHERCHE VOCALE AVEC IA CONTEXTUELLE ===
            const handleVoiceSearch = async (question) => {
                await performContextualSearch(question, searchMode);
                setUserQuestion('');
            };

            // Charger le texte quand livre/section change
            useEffect(() => {
                loadSefariaText();
            }, [selectedBook, selectedSection]);

            return (
                <div className="min-h-screen bg-spiritual-900 text-white">
                    {/* HEADER */}
                    <header className="bg-spiritual-800 border-b border-spiritual-700 p-4">
                        <div className="max-w-7xl mx-auto">
                            <h1 className="text-2xl font-bold text-sacred-400 mb-4">
                                üïäÔ∏è Le Compagnon du C≈ìur - Layout Carr√©s Trilingue
                            </h1>
                            
                            {/* S√©lecteurs et contr√¥les */}
                            <div className="flex flex-wrap gap-4 mb-4">
                                <select
                                    value={selectedBook}
                                    onChange={(e) => setSelectedBook(e.target.value)}
                                    className="px-3 py-2 bg-spiritual-700 border border-spiritual-600 rounded text-white"
                                >
                                    {availableBooks.map(book => (
                                        <option key={book} value={book}>{book}</option>
                                    ))}
                                </select>
                                
                                <input
                                    type="number"
                                    value={selectedSection}
                                    onChange={(e) => {
                                        const newValue = parseInt(e.target.value);
                                        const maxChapters = getMaxChapters(selectedBook);
                                        if (newValue <= maxChapters) {
                                            setSelectedSection(e.target.value);
                                        }
                                    }}
                                    min="1"
                                    max={getMaxChapters(selectedBook)}
                                    className="px-3 py-2 bg-spiritual-700 border border-spiritual-600 rounded text-white w-20"
                                    placeholder={`Section (1-${getMaxChapters(selectedBook)})`}
                                />
                                
                                <button
                                    onClick={loadSefariaText}
                                    disabled={isLoading}
                                    className="px-4 py-2 bg-sacred-600 hover:bg-sacred-700 disabled:opacity-50 rounded text-white"
                                >
                                    {isLoading ? '‚è≥ Chargement...' : 'üìñ Charger'}
                                </button>
                            </div>
                            
                            {/* MODE DE RECHERCHE CONTEXTUELLE */}
                            <div className="flex flex-wrap gap-4 mb-4">
                                <label className="text-sm text-gray-300">Mode de recherche :</label>
                                <select
                                    value={searchMode}
                                    onChange={(e) => setSearchMode(e.target.value)}
                                    className="px-3 py-1 bg-spiritual-700 border border-spiritual-600 rounded text-white text-sm"
                                >
                                    {searchModes.map(mode => (
                                        <option key={mode} value={mode}>{mode}</option>
                                    ))}
                                </select>
                                
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => performContextualSearch(userQuestion || 'R√©sum√© du contenu', 'Contexte de cet enseignement')}
                                        disabled={isSearching}
                                        className="px-2 py-1 bg-purple-600 hover:bg-purple-700 disabled:opacity-50 rounded text-xs"
                                    >
                                        üìñ Cet enseignement
                                    </button>
                                    
                                    <button
                                        onClick={() => performContextualSearch(userQuestion || 'R√©sum√© du livre', 'Contexte de ce livre')}
                                        disabled={isSearching}
                                        className="px-2 py-1 bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 rounded text-xs"
                                    >
                                        üìö Ce livre
                                    </button>
                                    
                                    <button
                                        onClick={() => performContextualSearch(userQuestion || 'Vue d\'ensemble', 'Contexte de tous les livres')}
                                        disabled={isSearching}
                                        className="px-2 py-1 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 rounded text-xs"
                                    >
                                        üåü Tous les livres
                                    </button>
                                </div>
                            </div>

                            {/* Contr√¥les TTS et traduction */}
                            <div className="flex flex-wrap gap-2">
                                <button
                                    onClick={translateToFrench}
                                    disabled={isTranslating || !englishText.length}
                                    className="px-3 py-1 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 rounded text-sm"
                                >
                                    {isTranslating ? '‚è≥ Traduction...' : 
                                     frenchProgress === 0 ? 'üá´üá∑ Traduire en fran√ßais' : 'üá´üá∑ Traduire suite'}
                                </button>
                                
                                {frenchText && frenchProgress < englishText.length && (
                                    <button
                                        onClick={continueTranslation}
                                        disabled={isTranslating}
                                        className="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 rounded text-sm"
                                    >
                                        {isTranslating ? '‚è≥' : `üìñ Suite (${frenchProgress}/${englishText.length})`}
                                    </button>
                                )}
                                
                                {frenchText && (
                                    <button
                                        onClick={() => setShowFrench(!showFrench)}
                                        className="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-sm"
                                    >
                                        {showFrench ? 'üëÅÔ∏è Masquer fran√ßais' : 'üëÅÔ∏è Voir fran√ßais'}
                                    </button>
                                )}

                                <button
                                    onClick={() => setShowEnglish(!showEnglish)}
                                    className="px-3 py-1 bg-gray-600 hover:bg-gray-700 rounded text-sm"
                                >
                                    {showEnglish ? 'üëÅÔ∏è Masquer anglais' : 'üëÅÔ∏è Voir anglais'}
                                </button>

                                <button
                                    onClick={() => speak(hebrewText.slice(0, 2).join(' '), 'he')}
                                    disabled={isSpeaking || !hebrewText.length}
                                    className="px-3 py-1 bg-purple-600 hover:bg-purple-700 disabled:opacity-50 rounded text-sm"
                                >
                                    üîä H√©breu
                                </button>
                                
                                <button
                                    onClick={() => speak(englishText.slice(0, 2).join(' '), 'en')}
                                    disabled={isSpeaking || !englishText.length}
                                    className="px-3 py-1 bg-orange-600 hover:bg-orange-700 disabled:opacity-50 rounded text-sm"
                                >
                                    üîä Anglais
                                </button>

                                {frenchText && (
                                    <button
                                        onClick={() => speak(frenchText.substring(0, 500), 'fr')}
                                        disabled={isSpeaking}
                                        className="px-3 py-1 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 rounded text-sm"
                                    >
                                        üîä Fran√ßais
                                    </button>
                                )}

                                {isSpeaking && (
                                    <button
                                        onClick={stopSpeaking}
                                        className="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm"
                                    >
                                        ‚èπÔ∏è Arr√™ter
                                    </button>
                                )}

                                <button
                                    onClick={() => setIsTTSEnabled(!isTTSEnabled)}
                                    className={`px-3 py-1 rounded text-sm ${isTTSEnabled ? 'bg-green-600' : 'bg-gray-600'}`}
                                >
                                    {isTTSEnabled ? 'üîä TTS ON' : 'üîá TTS OFF'}
                                </button>
                            </div>
                        </div>
                    </header>

                    <div className="max-w-7xl mx-auto p-4">
                        {isLoading ? (
                            <div className="text-center py-12">
                                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-sacred-400 mx-auto mb-4"></div>
                                <p>Extraction du texte depuis Sefaria...</p>
                            </div>
                        ) : (
                            <>
                                {/* LAYOUT EN CARR√âS - H√âBREU ET ANGLAIS C√îTE √Ä C√îTE */}
                                <div className={`grid gap-6 mb-6 ${showEnglish ? 'md:grid-cols-2' : 'md:grid-cols-1'}`}>
                                    {/* CARR√â ANGLAIS */}
                                    {showEnglish && (
                                        <div>
                                            <h3 className="text-xl font-bold mb-4 text-blue-300 border-b border-blue-500 pb-2">
                                                üìñ English Text
                                            </h3>
                                            <div className="text-container">
                                                {englishText.length > 0 ? englishText.map((paragraph, index) => (
                                                    <p key={index} className="mb-4 text-spiritual-200 leading-relaxed">
                                                        {paragraph}
                                                    </p>
                                                )) : (
                                                    <p className="text-spiritual-400 italic">English text loading...</p>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* CARR√â H√âBREU */}
                                    <div>
                                        <h3 className="text-xl font-bold mb-4 text-sacred-300 border-b border-sacred-500 pb-2">
                                            üìú ◊ò◊ß◊°◊ò ◊¢◊ë◊®◊ô
                                        </h3>
                                        <div className="text-container">
                                            {hebrewText.length > 0 ? hebrewText.map((paragraph, index) => (
                                                <p key={index} className="mb-4 text-spiritual-200 leading-relaxed text-right hebrew-text rtl-text">
                                                    {paragraph}
                                                </p>
                                            )) : (
                                                <p className="text-spiritual-400 italic text-right">◊ò◊ß◊°◊ò ◊¢◊ë◊®◊ô ◊ë◊ò◊¢◊ô◊†◊î...</p>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* CARR√â FRAN√áAIS LAZY EN BAS - D√âFILABLE */}
                                {showFrench && frenchText && (
                                    <div className="mb-6 fade-in">
                                        <h3 className="text-xl font-bold mb-4 text-green-300 border-b border-green-500 pb-2">
                                            üá´üá∑ Traduction Fran√ßaise
                                        </h3>
                                        <div className="text-container french-container">
                                            <div className="text-spiritual-200 leading-relaxed whitespace-pre-wrap">
                                                {frenchText}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* ZONE RECHERCHE IA */}
                                <div className="mt-8">
                                    <h3 className="text-xl font-bold mb-4 text-sacred-300 border-b border-sacred-500 pb-2">
                                        ü§ñ Recherche IA dans le Texte
                                    </h3>
                                    
                                    {/* Messages de conversation */}
                                    <div className="bg-spiritual-800/40 rounded-lg p-4 mb-4 max-h-60 overflow-y-auto">
                                        {messages.length === 0 ? (
                                            <p className="text-spiritual-400 italic text-center">
                                                Posez votre question sur ce texte...
                                            </p>
                                        ) : (
                                            messages.map((msg, idx) => (
                                                <div key={idx} className={`mb-3 p-3 rounded ${
                                                    msg.type === 'user' ? 'bg-blue-600/20 border-l-2 border-blue-400' :
                                                    msg.type === 'ai' ? 'bg-green-600/20 border-l-2 border-green-400' :
                                                    'bg-red-600/20 border-l-2 border-red-400'
                                                }`}>
                                                    <div className="text-sm text-spiritual-300 mb-1">
                                                        {msg.type === 'user' ? 'üë§ Vous' : 
                                                         msg.type === 'ai' ? 'ü§ñ Guide Spirituel' : '‚ö†Ô∏è Erreur'}
                                                    </div>
                                                    <div className="text-spiritual-100">{msg.content}</div>
                                                    {msg.source && (
                                                        <div className="text-xs text-spiritual-400 mt-1">
                                                            üìö Source: {msg.source}
                                                        </div>
                                                    )}
                                                </div>
                                            ))
                                        )}
                                    </div>
                                    
                                    {/* Input recherche */}
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={userQuestion}
                                            onChange={(e) => setUserQuestion(e.target.value)}
                                            placeholder="Posez votre question sur ce texte..."
                                            className="flex-1 px-4 py-3 bg-spiritual-700 border border-spiritual-600 rounded text-white"
                                            onKeyPress={(e) => {
                                                if (e.key === 'Enter') {
                                                    performContextualSearch(userQuestion, searchMode);
                                                }
                                            }}
                                        />
                                        
                                        <button
                                            onClick={() => performContextualSearch(userQuestion, searchMode)}
                                            disabled={isSearching || !userQuestion.trim()}
                                            className="px-6 py-3 bg-sacred-600 hover:bg-sacred-700 disabled:opacity-50 rounded text-white"
                                        >
                                            {isSearching ? `‚è≥ (${searchMode})` : `üîç ${searchMode}`}
                                        </button>
                                        
                                        <button
                                            onClick={startListening}
                                            disabled={isListening}
                                            className={`px-4 py-3 rounded text-white ${
                                                isListening ? 'bg-red-600 animate-pulse' : 'bg-purple-600 hover:bg-purple-700'
                                            }`}
                                        >
                                            {isListening ? 'üî¥ √âcoute...' : 'üé§'}
                                        </button>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        // Rendu de l'application
        ReactDOM.render(<CarreTrilingueApp />, document.getElementById('carre-trilingue-app'));
    </script>
</body>
</html>